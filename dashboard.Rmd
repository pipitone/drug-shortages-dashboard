---
title: "Assessing Canada’s Drug Shortage Problem"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
---

```{r setup, include=FALSE}
options(tidyverse.quiet=T)
library(flexdashboard)
library(tidyverse)
library(lubridate, warn.conflicts=F)
library(devtools, quietly=T)
library(drugshortagesr)
library(kableExtra, warn.conflicts=F)
#library(plotly)

# settings
DPD_URL_BASE = 'https://www.canada.ca/content/dam/hc-sc/documents/services/drug-product-database/'
DPD_DATA_DIR = 'data/'  # Load the Health Canada Drug Product Database
DPD_DOWNLOAD = getOption('dpd_download', default=T) # download the latest drug product database dataset
DSC_DOWNLOAD = getOption('dsc_download', default=T) # download latest DSC database
DSC_PATH     = 'data/dsc.csv'
DSC_START    = ymd("2017-03-01", tz="EST")
FAR_FUTURE   = ymd("2100-12-31", tz="EST")
FAR_PAST     = origin

theme_set(theme_minimal())
caption = list(labs(caption =  paste(
  paste(
    "source: drugshortagescanada.ca, last updated:", as_date(file.info(DSC_PATH)$ctime)), 
    "source: Health Canada Drug Product Database",
    "jon.pipitone.ca/research/drug-shortages", 
    sep="\n")))

# load data
if (DSC_DOWNLOAD) { 
  dsc = dsc_search()  %>%
    select_if(~ !is.list(.x)) %>%
    write_csv(DSC_PATH)
}
dsc = read_csv(DSC_PATH, trim_ws = T, col_types = cols(
  status = col_factor(),
  drug.company.post_office_box = col_character(),
  hc_en_comments = col_character(), 
  hc_fr_comments = col_character(),
  shortage_reason.en_reason = col_factor()
  )) %>%
  select(-matches("^fr_|\\.fr_|_fr")) %>%
  mutate(
    reason = fct_recode(shortage_reason.en_reason,  
      "Demand increase" = "Demand increase for the drug.", 
      "Manufacturing distruption" = "Disruption of the manufacture of the drug.",
      "Ingredient shortage" = "Shortage of an active ingredient.", 
      "Ingredient shortage" = "Shortage of an inactive ingredient or component.",
      "Manufacturing practices" = "Requirements related to complying with good manufacturing practices.",
      "Other" = "Other (Please describe in comments)",
      "Shipping delay" = "Delay in shipping of the drug." 
    ) 
  ) %>%
  mutate(
    end_date_no_na = coalesce(actual_end_date, estimated_end_date, FAR_FUTURE), 
    start_date_no_na = coalesce(actual_start_date, anticipated_start_date, FAR_PAST))

## Parsual EML
# https://dx.doi.org/10.9778%2Fcmajo.20160122
eml = read_csv('data/cleanmeds.csv', trim_ws=T, col_types = cols()) %>% 
  select(category, medication, ATC)

## DPD
if(DPD_DOWNLOAD) {
  for (f in c('allfiles.zip', 'allfiles_ia.zip', 'allfiles_ap.zip', 'allfiles_dr.zip')) {
    destfile = paste0(DPD_DATA_DIR, f)
    download.file(paste0(DPD_URL_BASE, f), destfile, quiet=T)
    unzip(destfile, exdir = DPD_DATA_DIR)
  }
}

.tables = list(
  comp = c("DRUG_CODE","MFR_CODE","COMPANY_CODE","COMPANY_NAME","COMPANY_TYPE",
           "ADDRESS_MAILING_FLAG","ADDRESS_BILLING_FLAG",
           "ADDRESS_NOTIFICATION_FLAG","ADDRESS_OTHER","SUITE_NUMBER",
           "STREET_NAME","CITY_NAME","PROVINCE","COUNTRY","POSTAL_CODE",
           "POST_OFFICE_BOX","PROVINCE_F","COUNTRY_F"),
  form = c("DRUG_CODE","PHARM_FORM_CODE","PHARMACEUTICAL_FORM",
           "PHARMACEUTICAL_FORM_F"),
  ingred = c("DRUG_CODE","ACTIVE_INGREDIENT_CODE","INGREDIENT",
             "INGREDIENT_SUPPLIED_IND","STRENGTH","STRENGTH_UNIT",
             "STRENGTH_TYPE","DOSAGE_VALUE","BASE","DOSAGE_UNIT","NOTES",
             "INGREDIENT_F","STRENGTH_UNIT_F","STRENGTH_TYPE_F","DOSAGE_UNIT_F"),
  package = c("DRUG_CODE","UPC","PACKAGE_SIZE_UNIT","PACKAGE_TYPE",
              "PACKAGE_SIZE","PRODUCT_INFORMATION","PACKAGE_SIZE_UNIT_F",
              "PACKAGE_TYPE_F"),
  pharm = c("DRUG_CODE","PHARMACEUTICAL_STD"),
  drug = c("DRUG_CODE","PRODUCT_CATEGORIZATION","CLASS",
           "DRUG_IDENTIFICATION_NUMBER","BRAND_NAME","DESCRIPTOR",
           "PEDIATRIC_FLAG","ACCESSION_NUMBER","NUMBER_OF_AIS",
           "LAST_UPDATE_DATE","AI_GROUP_NO","CLASS_F","BRAND_NAME_F",
           "DESCRIPTOR_F"),
  route = c("DRUG_CODE","ROUTE_OF_ADMINISTRATION_CODE",
            "ROUTE_OF_ADMINISTRATION","ROUTE_OF_ADMINISTRATION_F"),
  sched = c("DRUG_CODE","SCHEDULE","SCHEDULE_F"),
  status = c("DRUG_CODE","CURRENT_STATUS_FLAG","STATUS","HISTORY_DATE",
             "STATUS_F","LOT_NUMBER","EXPIRATION_DATE"),
  ther = c("DRUG_CODE","TC_ATC_NUMBER","TC_ATC","TC_AHFS_NUMBER","TC_AHFS",
           "TC_ATC_F","TC_AHFS_F"),
  vet = c("DRUG_CODE","VET_SPECIES","VET_SUB_SPECIES","VET_SPECIES_F")
)

dpd = list()
for (table_name in names(.tables)) {
  headers = .tables[[table_name]]
  # load corresponding files (active, inactive, etc..) and merge them
  dpd[[table_name]] = 
    dir(DPD_DATA_DIR, pattern = paste0(table_name, '.*.txt$'), full.names = T) %>%
      keep(function(x) file.size(x) > 0) %>%
      map(read_csv, col_names = headers, 
          locale = locale('en', date_format = '%d-%b-%Y'), 
          col_types = map(headers,  function (x) # guess base on name 
            case_when(endsWith(x, '_DATE') ~ 'D',  x == 'DRUG_CODE' ~ 'i',  T ~ 'c')) %>% 
          setNames(headers), progress = F) %>%
      reduce(rbind) %>%
      select(-ends_with("_F"))  # je ne parle pas bien le francais 
}

## Add the DPD ATC number to the DSC data
dsc = inner_join(dpd$drug, dpd$ther, by="DRUG_CODE") %>% 
  select(din = DRUG_IDENTIFICATION_NUMBER, dpd_atc_number = TC_ATC_NUMBER) %>% 
  distinct() %>%
  right_join(dsc, by=c("din"))
dsc.shortages = dsc %>% filter(type.label == "shortage")
dsc.discontinuations = dsc %>% filter(type.label == "discontinuance")

this_year = interval(floor_date(now(), "year"), ceiling_date(now(), "year"))
week_start = floor_date(now(), "week")
this_week = interval(week_start, week_start + weeks(1))
next_week = int_shift(this_week, by = weeks(1))
```

Shortages
==========

Row {data-height=125}
--------------------------------

### Active shortages this week
```{r}
.active_shortages = dsc.shortages %>% 
  filter(
    status == "active_confirmed", 
    now() %within% interval(actual_start_date, end_date_no_na))
shortages = nrow(.active_shortages)
valueBox(shortages, 
         icon="fa-capsules", 
         color = ifelse(shortages>0, "warning", "primary"))
```

### New shortages this week
```{r}
.shortages_this_week =  dsc.shortages %>% 
  filter(
    status %in% c("active_confirmed", "anticipated_shortage"), 
    coalesce(actual_start_date, anticipated_start_date) %within% this_week)
valueBox(nrow(.shortages_this_week),icon="fa-needle")
```

### New discontinuations this week
```{r}
.active_disconts = dsc.discontinuations  %>% 
  filter(
    status == "discontinued", 
    discontinuation_date %within% this_week)
valueBox(nrow(.active_disconts), icon="fa-ban")
```

### Shortages of Essential Medicines this year
```{r}
.emls_with_shortages = dsc.shortages %>%
  filter(actual_start_date %within% this_year) %>%
  right_join(eml, by=c("dpd_atc_number" = "ATC"))  %>%
  filter(!is.na(din))  %>%
  group_by(category, medication, dpd_atc_number)
valueBox(nrow(.emls_with_shortages), icon="fa-ambulance")
```



Row
-----------------------------------------------------------------------

### Upcoming new and anticipated shortages
```{r}
options(knitr.kable.NA = '')

dsc.shortages %>% 
  mutate(start_date = date(coalesce(actual_start_date, anticipated_start_date))) %>%
  filter(status %in% c("active_confirmed", "anticipated_shortage"), 
         start_date %within% interval(week_start, week_start + dweeks(2)))  %>%
  arrange(start_date) %>%
  mutate(duration = round((start_date %--% estimated_end_date)/days(1)),
         start_date = format(start_date, "%b %d, %Y"),
         status = fct_recode(status, "Active" = "active_confirmed", "Anticipated" = "anticipated_shortage"), 
         link = text_spec(id, link=paste0("https://www.drugshortagescanada.ca/shortage/", id))) %>%
  select(en_drug_brand_name, drug_strength, status, start_date, duration, reason, link) %>%
  kable(col.names = c("Drug Name", "Dose", "Status", "Start", "Duration (days)", "Reason", "View report"), escape=F) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width=F) %>%
    column_spec(3, width="9em")
```

Row {data-height=300} 
----------------------------------
### Drugs in shortage
```{r, fig.height=3}
months = tibble(
  month.start = seq(DSC_START, floor_date(now(), "month"), by = "1 month"), 
  i = 1
)
dsc.shortages %>%
  mutate(i = 1) %>%
  full_join(months, by = "i") %>%
  filter(month.start %within% interval(actual_start_date, end_date_no_na)) %>%
  group_by(month.start) %>%
  summarize(n = n()) %>%
  ggplot( aes(x = month.start, y = n)) + 
  geom_point() + geom_line() + 
  labs(x = NULL, y = NULL)  
```


### Causes of drug shortages this year {.no-padding}
```{r, fig.height=4, asp=0.6}
p = dsc.shortages %>% 
  filter(actual_start_date %within% this_year) %>% 
  mutate(reason=fct_infreq(reason)) %>%
  group_by(reason) %>%
  summarize(shortages=n()) %>%
  mutate(percent=shortages/sum(shortages)*100) %>% 
  ggplot(aes(y=percent,fill=reason,hjust="left")) + 
  xlim(1,4) + 
  geom_bar(aes(x=2.5), width=.5,stat="identity") + 
  geom_text(
    aes(x=2.1, label = paste0(round(percent), "%")), 
    position = position_stack(vjust = 0.5), 
    size=4, 
    check_overlap = T) +
  geom_text(
    aes(x=2.9, label = reason, angle=30), 
    position = position_stack(vjust = .5), 
    size=4, 
    check_overlap = T) +
  coord_flip() + 
  labs(x=NULL,y=NULL,fill=NULL) + 
  theme_classic() + 
  theme(
    legend.position = "none", 
    text = element_text(size=15),
    axis.line=element_blank(), 
    axis.text=element_blank(), 
    axis.ticks=element_blank()) 
p
```



About
=====

Column
------

### About this website

Hello. I am Jon Pipitone, medical student at Queen's University, Kingston, Ontario, Canada.

This website is a dashboard to display my ongoing research into drug shortages in Canada. You can follow my progress on my blog https://jon.pipitone.ca/blog. 

This work is done under supervision by [Dr. Jacalyn Duffin](https://jacalynduffin.ca/), and is an extension of our earlier analysis: 

*Donelle, Jessy, Jacalyn Duffin, Jonathan Pipitone, and Brian White-Guay. “Assessing Canada’s Drug Shortage Problem.” CD Howe Institute Commentary 515, 2018. https://doi.org/10.2139/ssrn.3192558.*

All of the code that powers this site, and other goodies can be found at https://github.com/pipitone/drug-shortages

*Disclaimer:* As this is ongoing research, the analysis and results presented here is likely to change, and has not undergone any peer review. 

Questions or comments? Please send me an email at jon@pipitone.ca

Column  {data-width=100}
----------------------------

### Data sources
##### [drugshortagescanada.ca](https://www.drugshortagescanada.ca)
Database of shortage and discontinuation reports.  Active from March 2017 to
present. Manufacturers are required to report.

##### [Drug Product Database](https://www.canada.ca/en/health-canada/services/drugs-health-products/drug-products/drug-product-database.html)
Database of historical records of drug products in Canada. Maintained by Health Canada.

##### [CLEANMeds Essential Medicines List](https://cleanmeds.ca)

### Terminology
**DSC**: Drug Shortages Canada database

**DPD**: Health Canada's Drug Products Database

**ATC**: Anatomical Therapeutic Chemical Classification system

